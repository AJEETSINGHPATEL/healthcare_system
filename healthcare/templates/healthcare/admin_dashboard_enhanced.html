{% extends 'healthcare/base.html' %}

{% block title_admin %}Admin Dashboard - HealthCare System{% endblock %}

{% block content %}
{% load static %}

<!-- Enhanced Admin Dashboard -->
<div class="admin-dashboard">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
            <p>Complete Healthcare Management System</p>
        </div>
        <div class="header-actions">
            <button class="btn-toggle-mode" onclick="toggleDarkMode()">
                <i class="fas fa-moon"></i>
            </button>
            <button class="btn-refresh" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ patients|length }}</h3>
                <p>Total Patients</p>
                <span class="stat-change positive">+{{ patients|length }} this month</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="stat-content">
                <h3>{{ doctors|length }}</h3>
                <p>Active Doctors</p>
                <span class="stat-change positive">+{{ doctors|length }} this week</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-content">
                <h3>{{ todays_appointments_count }}</h3>
                <p>Today's Appointments</p>
                <span class="stat-change positive">+{{ todays_appointments_count }} today</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>100%</h3>
                <p>System Health</p>
                <span class="stat-change positive">All systems operational</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-grid">
            <button class="action-card" onclick="showAddPatient()">
                <i class="fas fa-user-plus"></i>
                <span>Add Patient</span>
            </button>
            <button class="action-card" onclick="showAddDoctor()">
                <i class="fas fa-user-md"></i>
                <span>Add Doctor</span>
            </button>
            <button class="action-card" onclick="viewAppointments()">
                <i class="fas fa-calendar-alt"></i>
                <span>Appointments</span>
            </button>
            <button class="action-card" onclick="viewReports()">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </button>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="data-sections">
        <div class="section-card">
            <h3>Recent Patients</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Last Visit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr>
                            <td>{{ patient.user.get_full_name|default:patient.user.username }}</td>
                            <td>{{ patient.user.email }}</td>
                            <td>{{ patient.phone|default:"N/A" }}</td>
                            <td>{{ patient.created_at|date:"M d, Y" }}</td>
                            <td>
                                <button class="btn-small" onclick="viewPatient({{ patient.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section-card">
            <h3>Active Doctors</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Specialization</th>
                            <th>Experience</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doctor in doctors %}
                        <tr>
                            <td>{{ doctor.user.get_full_name|default:doctor.user.username }}</td>
                            <td>{{ doctor.specialization|default:"General" }}</td>
                            <td>{{ doctor.experience_years|default:"N/A" }} years</td>
                            <td>
                                <span class="status-badge active">Active</span>
                            </td>
                            <td>
                                <button class="btn-small" onclick="viewDoctor({{ doctor.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="system-status">
        <h3>System Status</h3>
        <div class="status-grid">
            <div class="status-item">
                <i class="fas fa-server"></i>
                <span>Database</span>
                <span class="status-indicator online">Online</span>
            </div>
            <div class="status-item">
                <i class="fas fa-shield-alt"></i>
                <span>Security</span>
                <span class="status-indicator secure">Secure</span>
            </div>
            <div class="status-item">
                <i class="fas fa-clock"></i>
                <span>Last Backup</span>
                <span class="status-time">2 hours ago</span>
            </div>
            <div class="status-item">
                <i class="fas fa-users"></i>
                <span>Active Sessions</span>
                <span class="status-count">47</span>
            </div>
        </div>
    </div>
    <!-- TODO: Update Last Backup time and Active Sessions count with dynamic data -->
</div>

<style>
.admin-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
}

.header-content h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.btn-toggle-mode, .btn-refresh {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 0.5rem;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-toggle-mode:hover, .btn-refresh:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-card:nth-child(1) .stat-icon {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.stat-card:nth-child(2) .stat-icon {
    background: linear-gradient(135deg, #f093fb, #f5576c);
}

.stat-card:nth-child(3) .stat-icon {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
}

.stat-card:nth-child(4) .stat-icon {
    background: linear-gradient(135deg, #43e97b, #38f9d7);
}

.stat-content h3 {
    font-size: 2rem;
    margin-bottom: 0.25rem;
}

.stat-change {
    font-size: 0.875rem;
}

.stat-change.positive {
    color: #10b981;
}

.quick-actions {
    margin-bottom: 2rem;
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.action-card {
    background: white;
    border: none;
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.action-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.action-card i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #667eea;
}

.data-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.section-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.btn-small {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.active {
    background: #dcfce7;
    color: #166534;
}

.system-status {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-indicator.online {
    background: #10b981;
}

.status-indicator.secure {
    background: #3b82f6;
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        text-align: center;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .data-sections {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Dashboard functionality
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const icon = document.querySelector('.btn-toggle-mode i');
    icon.className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
}

function refreshData() {
    const btn = document.querySelector('.btn-refresh');
    btn.classList.add('rotating');
    
    // Make AJAX request to refresh data
    fetch(window.location.href, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.text())
    .then(html => {
        // Create a temporary div to parse the returned HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Update the stats
        document.querySelector('.stats-grid').innerHTML = doc.querySelector('.stats-grid').innerHTML;
        
        // Update the data tables
        document.querySelector('.data-sections').innerHTML = doc.querySelector('.data-sections').innerHTML;
        
        // Update the system status
        document.querySelector('.system-status').innerHTML = doc.querySelector('.system-status').innerHTML;
        
        // Remove rotating class after a short delay
        setTimeout(() => btn.classList.remove('rotating'), 1000);
    })
    .catch(error => {
        console.error('Error refreshing data:', error);
        // Remove rotating class even if there's an error
        setTimeout(() => btn.classList.remove('rotating'), 1000);
    });
}

function showAddPatient() {
    window.location.href = "{% url 'healthcare:add_patient' %}";
}

function showAddDoctor() {
    // Check if add_doctor URL exists
    const addDoctorUrl = "{% url 'healthcare:add_doctor' %}";
    if (addDoctorUrl) {
        window.location.href = addDoctorUrl;
    } else {
        alert('Add Doctor functionality is not yet implemented.');
    }
}

function viewAppointments() {
    window.location.href = "{% url 'healthcare:appointments' %}";
}

function viewReports() {
    window.location.href = "{% url 'healthcare:admin_reports' %}";
}

function viewPatient(id) {
    window.location.href = "/healthcare/patient/" + id + "/";
}

function viewDoctor(id) {
    window.location.href = "/healthcare/doctor/" + id + "/";
}
</script>
{% endblock %}
