{% load custom_filters %}

<!-- Enhanced Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stats-card primary">
            <div class="stats-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stats-content">
                <h3 class="stats-number">{{ total_users }}</h3>
                <p class="stats-label">Total Users</p>
                <div class="stats-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12%</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stats-card success">
            <div class="stats-icon">
                <i class="fas fa-user-injured"></i>
            </div>
            <div class="stats-content">
                <h3 class="stats-number">{{ total_patients }}</h3>
                <p class="stats-label">Total Patients</p>
                <div class="stats-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+8%</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stats-card info">
            <div class="stats-icon">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="stats-content">
                <h3 class="stats-number">{{ total_doctors }}</h3>
                <p class="stats-label">Total Doctors</p>
                <div class="stats-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+5%</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stats-card warning">
            <div class="stats-icon">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="stats-content">
                <h3 class="stats-number">{{ total_admins }}</h3>
                <p class="stats-label">Total Admins</p>
                <div class="stats-trend">
                    <i class="fas fa-minus"></i>
                    <span>0%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Search Section -->
<div class="filters-section mb-4">
    <div class="card">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="form-control" id="userSearch" placeholder="Search users by name, email, or username...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="doctor">Doctor</option>
                        <option value="patient">Patient</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sortBy">
                        <option value="date_joined">Registration Date</option>
                        <option value="username">Username</option>
                        <option value="first_name">Name</option>
                        <option value="email">Email</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Data Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>User Management
        </h5>
        <div class="table-actions">
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> CSV
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Excel
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead class="table-light">
                    <tr>
                        <th class="sortable" data-column="username">
                            <i class="fas fa-user me-1"></i>Username
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="name">
                            <i class="fas fa-id-card me-1"></i>Full Name
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="email">
                            <i class="fas fa-envelope me-1"></i>Email
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="role">
                            <i class="fas fa-user-tag me-1"></i>Role
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="status">
                            <i class="fas fa-circle me-1"></i>Status
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="date_joined">
                            <i class="fas fa-calendar me-1"></i>Registration Date
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in recent_users %}
                    <tr class="user-row" data-role="{% if user.is_staff %}admin{% elif user|has_doctor_profile %}doctor{% elif user|has_patient_profile %}patient{% else %}user{% endif %}" data-status="{% if user.is_active %}active{% else %}inactive{% endif %}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle me-2">
                                    {{ user.first_name|first|default:user.username|first|upper }}
                                </div>
                                <span>{{ user.username }}</span>
                            </div>
                        </td>
                        <td>{{ user.first_name }} {{ user.last_name }}</td>
                        <td>
                            <a href="mailto:{{ user.email }}" class="text-decoration-none">{{ user.email }}</a>
                        </td>
                        <td>
                            {% if user.is_staff %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-user-shield me-1"></i>Admin
                                </span>
                            {% else %}
                                {% load custom_filters %}
                                {% if user|has_patient_profile %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-user-injured me-1"></i>Patient
                                    </span>
                                {% elif user|has_doctor_profile %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-user-md me-1"></i>Doctor
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-user me-1"></i>User
                                    </span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Active
                                </span>
                            {% else %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times-circle me-1"></i>Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-muted">{{ user.date_joined|date:"M d, Y" }}</span>
                            <br>
                            <small class="text-muted">{{ user.date_joined|date:"H:i" }}</small>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewUserDetails({{ user.id }})" data-bs-toggle="tooltip" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editUser({{ user.id }})" data-bs-toggle="tooltip" title="Edit User">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No users found</h5>
                                <p class="text-muted">Try adjusting your search criteria</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="User table pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>
                <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">2</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">3</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<script>
// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeUserReports();
});

function initializeUserReports() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Add event listeners
    setupSearch();
    setupFilters();
    setupSorting();
    setupPagination();
}

// Search functionality
function setupSearch() {
    const searchInput = document.getElementById('userSearch');
    searchInput.addEventListener('input', debounce(filterUsers, 300));
}

function setupFilters() {
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const sortBy = document.getElementById('sortBy');

    roleFilter.addEventListener('change', filterUsers);
    statusFilter.addEventListener('change', filterUsers);
    sortBy.addEventListener('change', sortUsers);
}

// Sorting functionality
function setupSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            sortUsers(column);
        });
    });
}

// Pagination setup
function setupPagination() {
    const paginationLinks = document.querySelectorAll('.page-link');
    paginationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.textContent;
            if (page !== 'Previous' && page !== 'Next') {
                goToPage(parseInt(page));
            }
        });
    });
}

// Filter users based on search and filters
function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    const userRows = document.querySelectorAll('.user-row');

    userRows.forEach(row => {
        const username = row.cells[0].textContent.toLowerCase();
        const name = row.cells[1].textContent.toLowerCase();
        const email = row.cells[2].textContent.toLowerCase();
        const role = row.getAttribute('data-role');
        const status = row.getAttribute('data-status');

        const matchesSearch = username.includes(searchTerm) ||
                             name.includes(searchTerm) ||
                             email.includes(searchTerm);

        const matchesRole = !roleFilter || role === roleFilter;
        const matchesStatus = !statusFilter || status === statusFilter;

        if (matchesSearch && matchesRole && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    updateEmptyState();
}

// Sort users
function sortUsers(sortBy = null) {
    if (!sortBy) {
        sortBy = document.getElementById('sortBy').value;
    }

    const table = document.getElementById('usersTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        let aValue, bValue;

        switch(sortBy) {
            case 'username':
                aValue = a.cells[0].textContent.toLowerCase();
                bValue = b.cells[0].textContent.toLowerCase();
                break;
            case 'first_name':
                aValue = a.cells[1].textContent.toLowerCase();
                bValue = b.cells[1].textContent.toLowerCase();
                break;
            case 'email':
                aValue = a.cells[2].textContent.toLowerCase();
                bValue = b.cells[2].textContent.toLowerCase();
                break;
            case 'date_joined':
            default:
                // For date sorting, we'd need to parse the date from the cell
                aValue = new Date(a.cells[5].querySelector('span').textContent);
                bValue = new Date(b.cells[5].querySelector('span').textContent);
                break;
        }

        if (aValue < bValue) return -1;
        if (aValue > bValue) return 1;
        return 0;
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// Clear all filters
function clearFilters() {
    document.getElementById('userSearch').value = '';
    document.getElementById('roleFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sortBy').value = 'date_joined';

    const userRows = document.querySelectorAll('.user-row');
    userRows.forEach(row => row.style.display = '');

    updateEmptyState();
}

// Apply filters
function applyFilters() {
    filterUsers();
}

// Go to specific page (placeholder for pagination)
function goToPage(page) {
    // Update active page
    const pageItems = document.querySelectorAll('.page-item');
    pageItems.forEach(item => item.classList.remove('active'));

    const targetPage = document.querySelector(`.page-link[href="#"][onclick*="${page}"]`);
    if (targetPage) {
        targetPage.closest('.page-item').classList.add('active');
    }

    // Here you would typically make an AJAX call to load the page data
    console.log(`Navigating to page ${page}`);
}

// Update empty state visibility
function updateEmptyState() {
    const visibleRows = document.querySelectorAll('.user-row:not([style*="display: none"])');
    const emptyState = document.querySelector('.empty-state');

    if (visibleRows.length === 0) {
        if (!emptyState) {
            const tbody = document.querySelector('#usersTable tbody');
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="7" class="text-center py-4">
                    <div class="empty-state">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No users found</h5>
                        <p class="text-muted">Try adjusting your search criteria</p>
                    </div>
                </td>
            `;
            tbody.appendChild(emptyRow);
        }
    } else {
        if (emptyState) {
            emptyState.closest('tr').remove();
        }
    }
}

// Export functions
function exportToCSV() {
    const table = document.getElementById('usersTable');
    const rows = table.querySelectorAll('tr:not([style*="display: none"])');
    let csvContent = "data:text/csv;charset=utf-8,";

    // Add headers
    const headers = [];
    const headerCells = table.querySelectorAll('thead th:not(:last-child)');
    headerCells.forEach(cell => {
        headers.push(cell.textContent.trim().replace(/\s+/g, ' '));
    });
    csvContent += headers.join(',') + "\n";

    // Add data rows
    rows.forEach(row => {
        if (row.querySelector('td')) {
            const cells = row.querySelectorAll('td:not(:last-child)');
            const rowData = [];
            cells.forEach(cell => {
                // Remove HTML tags and clean up text
                const text = cell.textContent.trim().replace(/\s+/g, ' ');
                rowData.push('"' + text + '"');
            });
            csvContent += rowData.join(',') + "\n";
        }
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "user_reports.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportToExcel() {
    // Placeholder for Excel export - would require additional library
    alert("Excel export functionality would be implemented with a library like SheetJS or similar");
}

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// User action functions (placeholders)
function viewUserDetails(userId) {
    // Placeholder for viewing user details
    console.log(`Viewing details for user ${userId}`);
    // You would typically open a modal or navigate to a detail page
}

function editUser(userId) {
    // Placeholder for editing user
    console.log(`Editing user ${userId}`);
    // You would typically open an edit modal or navigate to an edit page
}

// Loading state management
function setLoadingState(isLoading) {
    const table = document.getElementById('usersTable');
    if (isLoading) {
        table.classList.add('loading');
    } else {
        table.classList.remove('loading');
    }
}

// Responsive adjustments
function handleResize() {
    const width = window.innerWidth;
    const avatarCircles = document.querySelectorAll('.avatar-circle');

    if (width < 576) {
        avatarCircles.forEach(circle => {
            circle.style.width = '30px';
            circle.style.height = '30px';
            circle.style.fontSize = '0.8rem';
        });
    } else {
        avatarCircles.forEach(circle => {
            circle.style.width = '35px';
            circle.style.height = '35px';
            circle.style.fontSize = '0.9rem';
        });
    }
}

// Initialize responsive handling
window.addEventListener('resize', debounce(handleResize, 250));
handleResize(); // Initial call
</script>

<style>
/* Enhanced Statistics Cards */
.stats-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: none;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.stats-card.primary::before { background: linear-gradient(90deg, #007bff 0%, #0056b3 100%); }
.stats-card.success::before { background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%); }
.stats-card.info::before { background: linear-gradient(90deg, #17a2b8 0%, #117a8b 100%); }
.stats-card.warning::before { background: linear-gradient(90deg, #ffc107 0%, #e0a800 100%); }

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.stats-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin-bottom: 1rem;
}

.stats-card.primary .stats-icon { background: rgba(0, 123, 255, 0.1); color: #007bff; }
.stats-card.success .stats-icon { background: rgba(40, 167, 69, 0.1); color: #28a745; }
.stats-card.info .stats-icon { background: rgba(23, 162, 184, 0.1); color: #17a2b8; }
.stats-card.warning .stats-icon { background: rgba(255, 193, 7, 0.1); color: #ffc107; }

.stats-number {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: #2d3748;
}

.stats-label {
    font-size: 0.9rem;
    color: #718096;
    margin: 0.5rem 0 0 0;
    font-weight: 500;
}

.stats-trend {
    display: flex;
    align-items: center;
    font-size: 0.8rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.stats-trend i {
    margin-right: 0.25rem;
}

.stats-card.primary .stats-trend { color: #007bff; }
.stats-card.success .stats-trend { color: #28a745; }
.stats-card.info .stats-trend { color: #17a2b8; }
.stats-card.warning .stats-trend { color: #ffc107; }

/* Search and Filters */
.search-box {
    position: relative;
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    z-index: 2;
}

.search-box .form-control {
    padding-left: 40px;
    border-radius: 25px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.search-box .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.filters-section .card {
    border: none;
    box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    border-radius: 12px;
}

.filters-section .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.filters-section .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Enhanced Table */
.table-responsive {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}

.table {
    margin-bottom: 0;
}

.table thead th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: none;
    font-weight: 600;
    color: #495057;
    padding: 1rem 0.75rem;
    position: relative;
}

.sortable {
    cursor: pointer;
    user-select: none;
    transition: all 0.3s ease;
}

.sortable:hover {
    background: rgba(0, 123, 255, 0.1);
    color: #007bff;
}

.sort-icon {
    margin-left: 0.5rem;
    opacity: 0.5;
    transition: all 0.3s ease;
}

.sortable:hover .sort-icon {
    opacity: 1;
}

.table tbody tr {
    transition: all 0.3s ease;
}

.table tbody tr:hover {
    background: rgba(0, 123, 255, 0.05);
    transform: scale(1.01);
}

.avatar-circle {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-weight: 500;
}

/* Actions */
.btn-group .btn {
    border-radius: 6px !important;
    margin: 0 1px;
    transition: all 0.3s ease;
}

.btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* Empty State */
.empty-state {
    padding: 2rem 0;
}

.empty-state i {
    opacity: 0.5;
}

/* Pagination */
.pagination {
    margin-bottom: 0;
}

.page-link {
    border-radius: 8px !important;
    margin: 0 2px;
    border: 2px solid #e9ecef;
    color: #007bff;
    font-weight: 500;
    transition: all 0.3s ease;
}

.page-link:hover {
    background: #007bff;
    border-color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.page-item.active .page-link {
    background: #007bff;
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .stats-card {
        margin-bottom: 1rem;
    }

    .filters-section .row > div {
        margin-bottom: 1rem;
    }

    .table-responsive {
        font-size: 0.9rem;
    }

    .avatar-circle {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
    }

    .btn-group {
        flex-direction: column;
    }

    .btn-group .btn {
        margin: 1px 0;
    }
}

@media (max-width: 576px) {
    .stats-number {
        font-size: 1.5rem;
    }

    .stats-icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* Custom Scrollbar */
.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
